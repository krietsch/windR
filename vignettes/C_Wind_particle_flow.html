<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Johannes Krietsch" />

<meta name="date" content="2019-03-12" />

<title>Wind data manipulation</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Wind data manipulation</h1>
<h4 class="author"><em>Johannes Krietsch</em></h4>
<h4 class="date"><em>2019-03-12</em></h4>



<p>This file describes how to make a particle flow animation using wind data.</p>
<p><strong>Summary</strong></p>
<ol style="list-style-type: decimal">
<li>Load wind data and create base map</li>
<li>Create particles</li>
<li>Create particle flow animation</li>
</ol>
<div id="load-packages-define-study-area-and-set-working-directory" class="section level2">
<h2>Load packages, define study area and set working directory</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Packages</span>
<span class="kw">sapply</span>(<span class="kw">c</span>(<span class="st">'magrittr'</span>, <span class="st">'data.table'</span>, <span class="st">'foreach'</span>, <span class="st">'windR'</span>, <span class="st">'raster'</span>, <span class="st">'foreach'</span>, <span class="st">'doParallel'</span>, <span class="st">'ggplot2'</span>, <span class="st">'stringr'</span>, <span class="st">'rgeos'</span>),
       <span class="cf">function</span>(x) <span class="kw">suppressPackageStartupMessages</span>(<span class="kw">require</span>(x , <span class="dt">character.only =</span> <span class="ot">TRUE</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>) ) )
<span class="co">#&gt;   magrittr data.table    foreach      windR     raster    foreach </span>
<span class="co">#&gt;       TRUE       TRUE       TRUE       TRUE       TRUE       TRUE </span>
<span class="co">#&gt; doParallel    ggplot2    stringr      rgeos </span>
<span class="co">#&gt;       TRUE       TRUE       TRUE       TRUE</span>

<span class="co"># Projection (polar Lambert azimuthal equal-area with longitude origin 156.65° W)</span>
PROJ   =<span class="st"> '+proj=laea +lat_0=90 +lon_0=-156.653428 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0 '</span>

<span class="co"># Specify directory</span>
wd =<span class="st"> </span><span class="kw">tempdir</span>() <span class="co"># temporary in this case (choose yourself)</span></code></pre></div>
</div>
<div id="load-wind-data-and-create-base-map" class="section level2">
<h2>1. Load wind data and create base map</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># load wind data</span>
wind_data =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">'ERA_Interrim'</span>, <span class="st">'ERA_Interrim_850mb_4_7_June_2014_10km.RDS'</span>, <span class="dt">package =</span> <span class="st">'windR'</span>)
w =<span class="st"> </span><span class="kw">readRDS</span>(wind_data)

<span class="co"># Get borders of the wind data</span>
w1 =<span class="st"> </span>w[datetime_ <span class="op">==</span><span class="st"> </span><span class="kw">unique</span>(w<span class="op">$</span>datetime_[<span class="dv">1</span>])]
wp =<span class="st"> </span><span class="kw">SpatialPoints</span>(<span class="kw">cbind</span>(w1<span class="op">$</span>x, w1<span class="op">$</span>y), <span class="dt">proj4string =</span> <span class="kw">CRS</span>(PROJ))
datBdry =<span class="st"> </span>rgeos<span class="op">::</span><span class="kw">gEnvelope</span>(wp)

<span class="co"># load high resolution map of area around Barrow</span>
map_data =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">'Map'</span>, <span class="st">'BRW_map.RDS'</span>, <span class="dt">package =</span> <span class="st">'windR'</span>)
BRW =<span class="st"> </span><span class="kw">readRDS</span>(map_data)
<span class="kw">plot</span>(BRW, <span class="dt">col =</span> <span class="st">'grey'</span>)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># example to get a simple map</span>
<span class="co"># library(maptools)</span>
<span class="co"># data(wrld_simpl)</span>
<span class="co"># wrld_c = crop(wrld_simpl, extent(-180, -120, 45, 90)) # crop broad area</span>
<span class="co"># wrld = spTransform(wrld_c, CRS(PROJ)) # change projection</span>
<span class="co"># BRW = wrld %&gt;% gIntersection(datBdry) # crop with border of the wind data</span>

<span class="co"># Create simple base map</span>
b  =<span class="st"> </span>datBdry <span class="op">%&gt;%</span><span class="st"> </span>fortify <span class="op">%&gt;%</span><span class="st"> </span>data.table
bb =<span class="st"> </span><span class="kw">gBuffer</span>(datBdry, <span class="dt">width =</span> <span class="dv">30000</span>) <span class="op">%&gt;%</span><span class="st"> </span>gEnvelope <span class="op">%&gt;%</span><span class="st"> </span>fortify <span class="op">%&gt;%</span><span class="st"> </span>data.table
wr =<span class="st"> </span>BRW <span class="op">%&gt;%</span><span class="st"> </span>fortify <span class="op">%&gt;%</span><span class="st"> </span>data.table

bm =
<span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(  <span class="dt">data =</span> bb, <span class="kw">aes</span>(long, lat), <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">colour =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="fl">.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(  <span class="dt">data =</span> b,  <span class="kw">aes</span>(long, lat), <span class="dt">fill =</span> <span class="st">'dodgerblue4'</span>, <span class="dt">colour =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="fl">.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(  <span class="dt">data =</span> wr, <span class="kw">aes</span>(long, lat, <span class="dt">group =</span> group), <span class="dt">fill   =</span> <span class="st">'steelblue4'</span> , <span class="dt">colour =</span> <span class="st">'white'</span>, <span class="dt">size =</span> <span class="fl">.2</span>) <span class="op">+</span>
<span class="st">  </span>rangeMapper<span class="op">::</span><span class="kw">theme_rangemap</span>()

<span class="kw">print</span>(bm)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="create-particles" class="section level2">
<h2>2. Create particles</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># define the temporal extent</span>
time_start =<span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="kw">as.Date</span>(<span class="st">'2014-06-04'</span>))
time_end   =<span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="kw">as.Date</span>(<span class="st">'2014-06-07'</span>))
time_steps =<span class="st"> '30 mins'</span>

ts =<span class="st"> </span><span class="kw">seq</span>(time_start, time_end, time_steps)

t_ext =<span class="st"> </span>ts
t_max =<span class="st"> </span><span class="kw">max</span>(ts)

<span class="co"># define the spatial extent</span>
ext   =<span class="st"> </span><span class="kw">extent</span>(datBdry)
x_ext =<span class="st"> </span><span class="kw">seq</span>(ext[<span class="dv">1</span>], ext[<span class="dv">2</span>])
y_ext =<span class="st"> </span><span class="kw">seq</span>(ext[<span class="dv">3</span>], ext[<span class="dv">4</span>])


<span class="co"># wind data</span>
w =<span class="st"> </span>wA
<span class="kw">setkey</span>(w, datetime_)
w_datetime_  =<span class="st"> </span><span class="kw">unique</span>(w<span class="op">$</span>datetime_)       <span class="co"># get vector of available wind data</span>

<span class="co"># number of particles</span>
NP_PP =<span class="st"> </span><span class="dv">10</span>                                 <span class="co"># number of particles per picture created</span>
NP    =<span class="st"> </span>NP_PP <span class="op">*</span><span class="st"> </span><span class="kw">length</span>(ts)               <span class="co"># number of particles</span>
TL    =<span class="st"> </span><span class="dv">50</span>                               <span class="co"># number of points for each track</span>
NP<span class="op">*</span>TL                                    <span class="co"># number of rows expected (will be smaller because some particles leave the map)</span>


<span class="co"># loop to create random particles</span>
o =<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span>NP, <span class="dt">.packages =</span> <span class="kw">c</span>(<span class="st">'data.table'</span>,<span class="st">'rgdal'</span>, <span class="st">'raster'</span>, <span class="st">'magrittr'</span>, <span class="st">'sp'</span>, <span class="st">'rgeos'</span>, <span class="st">'raster'</span>, <span class="st">'windR'</span>) ) <span class="op">%do%</span><span class="st"> </span>{

  <span class="kw">cat</span>(i, <span class="st">'_of_'</span>, NP, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>, <span class="dt">file =</span> <span class="kw">paste0</span>(wd, <span class="st">'/ProcessBar.txt'</span>))

  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>TL){

    <span class="cf">if</span> (k <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {

      <span class="co"># random start date</span>
      rd =<span class="st"> </span><span class="kw">sample</span>(t_ext, <span class="dv">1</span>)

      tmp =<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">particle_id  =</span> <span class="kw">rep</span>(i, TL),
                       <span class="dt">point_id     =</span> <span class="dv">1</span><span class="op">:</span>TL,
                       <span class="dt">datetime_    =</span> <span class="kw">seq</span>(rd, rd <span class="op">+</span><span class="st"> </span><span class="dv">1800</span> <span class="op">*</span><span class="st"> </span>(TL <span class="op">-</span><span class="st"> </span><span class="dv">1</span>), <span class="dt">by =</span> time_steps))

      <span class="kw">setkey</span>(tmp, point_id)
      tmp[, w_date <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">closestDatetime</span>(datetime_, w_datetime_), by =<span class="st"> </span>point_id]

      <span class="co"># random start point</span>
      <span class="kw">set</span>(tmp, 1L, <span class="st">'x'</span>, <span class="dt">value =</span> <span class="kw">sample</span>(x_ext, <span class="dv">1</span>, <span class="dt">replace=</span><span class="ot">TRUE</span>))
      <span class="kw">set</span>(tmp, 1L, <span class="st">'y'</span>, <span class="dt">value =</span> <span class="kw">sample</span>(y_ext, <span class="dv">1</span>, <span class="dt">replace=</span><span class="ot">TRUE</span>))

      tmp[<span class="dv">1</span>, <span class="kw">c</span>(<span class="st">'u'</span>, <span class="st">'v'</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">getWind</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">w =</span> w[<span class="kw">J</span>(w_date), <span class="dt">nomatch=</span>0L], PROJ)]

    } <span class="cf">else</span> {

      <span class="cf">if</span> (<span class="kw">is.na</span>(tmp[k<span class="dv">-1</span>, u]) <span class="op">|</span><span class="st"> </span>tmp[k, datetime_ <span class="op">&gt;</span><span class="st"> </span>t_max]) {

        tmp =<span class="st"> </span><span class="kw">na.omit</span>(tmp)

      } <span class="cf">else</span> {

        <span class="kw">set</span>(tmp, k , 5L, <span class="dt">value =</span> tmp[k<span class="dv">-1</span>, x] <span class="op">+</span><span class="st"> </span>tmp[k<span class="dv">-1</span>, u] <span class="op">*</span><span class="st"> </span><span class="dv">1800</span>)
        <span class="kw">set</span>(tmp, k , 6L, <span class="dt">value =</span> tmp[k<span class="dv">-1</span>, y] <span class="op">+</span><span class="st"> </span>tmp[k<span class="dv">-1</span>, v] <span class="op">*</span><span class="st"> </span><span class="dv">1800</span>)

        tmp[k, <span class="kw">c</span>(<span class="st">'u'</span>, <span class="st">'v'</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">getWind</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">w =</span> w[<span class="kw">J</span>(w_date), <span class="dt">nomatch=</span>0L], PROJ)]

      }
    }
  }

  tmp

}


ob =<span class="st"> </span><span class="kw">rbindlist</span>(o)

<span class="kw">saveRDS</span>(ob, <span class="kw">paste0</span>(wd, <span class="st">'Wind_particles.RDS'</span>))</code></pre></div>
</div>
<div id="create-particle-flow-animation" class="section level2">
<h2>3. Create particle flow animation</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># load particles and calculate the wind speed</span>
particle_data =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">'Map'</span>, <span class="st">'Wind_particles.RDS'</span>, <span class="dt">package =</span> <span class="st">'windR'</span>)
ob =<span class="st"> </span><span class="kw">readRDS</span>(particle_data)
<span class="kw">setkey</span>(ob, datetime_)
ob[, w_speed <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sqrt</span>(u<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>v<span class="op">^</span><span class="dv">2</span>)]

<span class="co"># Set time frame and path</span>
ts =<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">date =</span> <span class="kw">seq</span>(<span class="st">'2014-06-04'</span> <span class="op">%&gt;%</span><span class="st"> </span>as.Date <span class="op">%&gt;%</span><span class="st"> </span>as.POSIXct, <span class="st">'2014-06-07'</span> <span class="op">%&gt;%</span><span class="st"> </span>as.Date <span class="op">%&gt;%</span><span class="st"> </span>as.POSIXct, <span class="dt">by =</span> <span class="st">'30 mins'</span>) )
<span class="kw">setkey</span>(ts, date)
tmp_path =<span class="st"> </span>wd <span class="co"># change path</span>
ts[, path <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(tmp_path, <span class="st">'/'</span>, <span class="kw">str_pad</span>(<span class="dv">1</span><span class="op">:</span>.N, <span class="dv">4</span>, <span class="st">'left'</span>, <span class="dt">pad =</span> <span class="st">'0'</span>), <span class="st">'.png'</span>)   ]

<span class="co"># Wind speed color scale</span>
Ws_min =<span class="st"> </span><span class="dv">0</span>
Ws_max =<span class="st"> </span><span class="kw">max</span>(ob<span class="op">$</span>w_speed, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
col_Ws =<span class="st"> </span><span class="kw">c</span>(<span class="st">'gold'</span>, <span class="st">'springgreen3'</span>, <span class="st">'springgreen4'</span>)
col_WS_v  =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)



<span class="co"># register parallel computing</span>
<span class="co"># cl = 20 %&gt;% makePSOCKcluster; registerDoParallel(cl)</span>

<span class="co"># loop that creates pictures for the animation</span>
<span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(ts), <span class="dt">.packages =</span> <span class="kw">c</span>(<span class="st">'scales'</span>, <span class="st">'ggplot2'</span>, <span class="st">'lubridate'</span>, <span class="st">'stringr'</span>, <span class="st">'data.table'</span>, <span class="st">'windR'</span>) ) <span class="op">%dopar%</span><span class="st"> </span>{

  <span class="kw">png</span>(<span class="dt">filename =</span> ts[i, path], <span class="dt">width =</span> <span class="dv">700</span>, <span class="dt">height =</span> <span class="dv">700</span>, <span class="dt">units =</span> <span class="st">&quot;px&quot;</span>, <span class="dt">pointsize =</span> <span class="dv">9</span>, <span class="dt">bg =</span> <span class="st">&quot;white&quot;</span>)

  <span class="co"># add track for particles</span>
  tail     =<span class="st"> </span><span class="dv">20</span>           <span class="co"># lenght of the running tail</span>
  tmp_date =<span class="st"> </span>ts[i]<span class="op">$</span>date   <span class="co"># current date</span>

  <span class="co"># subset particles</span>
  tmp_date_sub =<span class="st"> </span><span class="kw">seq</span>(tmp_date  <span class="op">-</span><span class="st"> </span><span class="dv">1800</span> <span class="op">*</span><span class="st"> </span>tail, tmp_date, <span class="dt">by =</span> <span class="st">'30 mins'</span>)
  pi =<span class="st"> </span>ob[<span class="kw">J</span>(tmp_date_sub), nomatch=0L]

  <span class="cf">if</span> (<span class="kw">nrow</span>(pi) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) pi[, a <span class="op">:</span><span class="er">=</span><span class="st">  </span><span class="kw">alphaAlong</span>(datetime_, <span class="dt">head =</span> <span class="dv">70</span>, <span class="dt">skew =</span> <span class="dv">-2</span>), by =<span class="st"> </span>particle_id] <span class="co"># alpha</span>

  bm_w =<span class="st"> </span>bm <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_path</span>(<span class="dt">data =</span> pi, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">group =</span> particle_id, <span class="dt">color =</span> w_speed), <span class="dt">alpha =</span> pi<span class="op">$</span>a) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_colour_gradientn</span>(<span class="dt">colours =</span> col_Ws, <span class="dt">values =</span> col_WS_v, <span class="dt">limits =</span> <span class="kw">c</span>(Ws_min, Ws_max), <span class="dt">name =</span> <span class="st">'Wind speed (m/s)'</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">'text'</span>, <span class="dt">x =</span> <span class="dv">0</span>, <span class="dt">y =</span> <span class="dv">-1730000</span>,
             <span class="dt">label =</span> <span class="kw">paste0</span>(<span class="st">'2014 '</span>, <span class="kw">format</span>(tmp_date, <span class="st">&quot;%B %d %H:00&quot;</span>)),
             <span class="dt">color =</span> <span class="st">'white'</span>, <span class="dt">size =</span> <span class="dv">8</span>, <span class="dt">fontface =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="co"># size = 5 normal resolution, 8 for high</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.direction =</span> <span class="st">'horizontal'</span>, <span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="fl">0.12</span>, <span class="fl">0.13</span>),
          <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">'bold'</span>, <span class="dt">color =</span> <span class="st">'white'</span>),
          <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">'bold'</span>, <span class="dt">color =</span> <span class="st">'white'</span>),
          <span class="dt">plot.margin =</span> <span class="kw">unit</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-1</span>, <span class="dv">-1</span>, <span class="dv">-1</span>), <span class="st">'cm'</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">guides</span>(<span class="dt">colour =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title.position =</span> <span class="st">'top'</span>, <span class="dt">title.hjust =</span> <span class="fl">0.5</span>, <span class="dt">barwidth =</span> <span class="dv">8</span>))


  <span class="kw">print</span>(bm_w)

  <span class="kw">dev.off</span>()

}


<span class="co"># close parallel clusters</span>
<span class="kw">stopCluster</span>(cl)
<span class="kw">registerDoSEQ</span>()


<span class="co"># merge png into animation using ffmpeg (or with a different programm)</span>

<span class="kw">setwd</span>(tmp_path)
<span class="kw">system</span>(<span class="st">&quot;ffmpeg -framerate 12 -pattern_type glob -i '*.png' -y -c:v libx264 -profile:v high -crf 1 -pix_fmt yuv420p WindParticleFlow_Barrow.mov&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()
<span class="co">#&gt; R version 3.5.2 (2018-12-20)</span>
<span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span>
<span class="co">#&gt; Running under: Ubuntu 18.04.2 LTS</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS: /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.7.1</span>
<span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.7.1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span>
<span class="co">#&gt;  [4] LC_COLLATE=C           LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span>
<span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span>
<span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] parallel  stats     graphics  grDevices utils     datasets  methods  </span>
<span class="co">#&gt; [8] base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] rgeos_0.3-28      stringr_1.4.0     ggplot2_3.1.0    </span>
<span class="co">#&gt;  [4] doParallel_1.0.14 iterators_1.0.10  raster_2.8-19    </span>
<span class="co">#&gt;  [7] sp_1.3-1          foreach_1.4.4     magrittr_1.5     </span>
<span class="co">#&gt; [10] windR_0.0.9       data.table_1.12.0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] pkgload_1.0.2       bit64_0.9-7         assertthat_0.2.0   </span>
<span class="co">#&gt;  [4] blob_1.1.1          yaml_2.2.0          remotes_2.0.2      </span>
<span class="co">#&gt;  [7] sessioninfo_1.1.1   pillar_1.3.1        RSQLite_2.1.1      </span>
<span class="co">#&gt; [10] backports_1.1.3     lattice_0.20-38     glue_1.3.0         </span>
<span class="co">#&gt; [13] digest_0.6.18       RColorBrewer_1.1-2  colorspace_1.4-0   </span>
<span class="co">#&gt; [16] htmltools_0.3.6     plyr_1.8.4          pkgconfig_2.0.2    </span>
<span class="co">#&gt; [19] devtools_2.0.1      purrr_0.3.1         scales_1.0.0       </span>
<span class="co">#&gt; [22] processx_3.3.0      tibble_2.0.1        usethis_1.4.0      </span>
<span class="co">#&gt; [25] withr_2.1.2         lazyeval_0.2.1      cli_1.0.1          </span>
<span class="co">#&gt; [28] crayon_1.3.4        memoise_1.1.0       maptools_0.9-5     </span>
<span class="co">#&gt; [31] evaluate_0.13       ps_1.3.0            fs_1.2.6           </span>
<span class="co">#&gt; [34] xml2_1.2.0          foreign_0.8-70      class_7.3-15       </span>
<span class="co">#&gt; [37] pkgbuild_1.0.2      tools_3.5.2         prettyunits_1.0.2  </span>
<span class="co">#&gt; [40] munsell_0.5.0       callr_3.1.1         compiler_3.5.2     </span>
<span class="co">#&gt; [43] e1071_1.7-0.1       rlang_0.3.1         classInt_0.3-1     </span>
<span class="co">#&gt; [46] grid_3.5.2          rstudioapi_0.9.0    labeling_0.3       </span>
<span class="co">#&gt; [49] rmarkdown_1.11      rangeMapper_0.3-4   testthat_2.0.1     </span>
<span class="co">#&gt; [52] gtable_0.2.0        codetools_0.2-16    DBI_1.0.0          </span>
<span class="co">#&gt; [55] roxygen2_6.1.1.9000 R6_2.4.0            gridExtra_2.3      </span>
<span class="co">#&gt; [58] knitr_1.22          dplyr_0.8.0.1       rgdal_1.4-2        </span>
<span class="co">#&gt; [61] bit_1.1-14          commonmark_1.7      rprojroot_1.3-2    </span>
<span class="co">#&gt; [64] desc_1.2.0          stringi_1.3.1       Rcpp_1.0.0         </span>
<span class="co">#&gt; [67] tidyselect_0.2.5    xfun_0.5</span></code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
